# Помпа Accu Chek Combo

**Настоящее ПО является частью самодеятельной разработки, а не готовым программным продуктом. От ВАС потребуется прочитать, изучить и понять систему и то, как ей пользоваться. Она не контролирует диабет за вас, но позволит улучшить компенсацию и качество жизни, если вы готовы уделить ей достаточно времени. Не бросайтесь в систему сломя голову, дайте себе время на изучение. Только вы несете ответственность за то, что делаете.**

(Accu-Chek-Combo-Pump-hardware-requirements)=

## Требования к оборудованию

- Помпа Roche Accu-Chek Combo (любая версия прошивки, работают все)
- Устройство Smartpix или Realtyme с приложением "360" для конфигурирования помпы под свои параметры. По вашему запросу фирма Roche бесплатно вышлет устройства и По. (как всегда, Россия здесь исключение. По крайней мере, переводчику данной документации ничего не выслали. Возможно, надо разговаривать с сотрудниками или руководителями фирмы, а не с агентами, чьи контакты нам обычно дают при установке помпы)
- Совместимый смартфон: телефон на Android с прошивкой LineageOS 14.1 (прежнее название - CyanogenMod) или Android 8.1 (Oreo). Начиная с AAPS 3.0 Android 9 является обязательным. См. подробности в [примечаниях к версиям](https://androidaps.readthedocs.io/en/latest/Installing-AndroidAPS/Releasenotes.html#android-version-and-aaps-version).
- LineageOS 14.1 должна иметь свежую версию, по крайней мере от июня 2017, когда в прошивку включили изменения, позволяющие соединяться с помпой Combo. 
- Список телефонов можно найти в документе [Телефоны, работающие с AAPS](https://docs.google.com/spreadsheets/d/1gZAsN6f0gv6tkgy9EBsYl0BQNhna0RDqA9QGycAqCQc/edit).
- Пожалуйста, имейте в виду, что это не полный список и отражает личный опыт пользователей. Вам предлагается также делиться результатами вашего опыта и тем самым помогать другим (все подобные проекты основаны на идеологии бескорыстной помощи).
- Имейте в виду, что в то время как Android 8.1 позволяет общаться с Combo, все еще есть проблемы с AAPS на 8.1.
- Для опытных пользователей можно выполнить сопряжение на телефоне с рут-правами и перенести его на другой телефон с руфи/AAPS, которые также должны быть рутированы. Такой подход позволяет пользоваться телефонами с версиями Android ниже 8.1, но он еще достаточно не опробован. https://github.com/gregorybel/combo-pairing/blob/master/README.md

## Ограничения

- Пролонгированный болюс и многоволновый болюс не поддерживаются (вместо них см. [Расширенные углеводы](../Usage/Extended-Carbs.md)).
- Поддерживается только один базальной профиль.
- Установка профиля, отличного от заданного на помпе или подача пролонгированного/многоволнового болюса с помпы конфликтует с временной скоростью базала TBR и приводит алгоритм ИПЖ к работе только в режиме приостановки на низких ГК в течение 6 часов поскольку безопасность работы цикла при этом нарушается.
- В настоящее время невозможно задать дату и время на помпе, поэтому [переходы с/на летнее/зимнее время](Timezone-traveling-accu-chek-combo) должны производиться вручную (вы можете деактивировать автоматический переход на телефоне вечером и утром изменить время на помпе и часах, чтобы избежать срабатывания сигнала оповещения ночью). (На территории России неактуально).
- В настоящее время поддерживаются только величины базала от 0.05 до 10 ед./час. Это также относится к изменениям профиля, например, при увеличении до 200% наивысшая скорость базала не должна превышать 5 ед/час, поскольку она удвоится. Аналогично, при снижении на 50%, самая низкая базальная скорость не должна быть меньше 0,10 U/ч.
- Если алгоритм цикла запрашивает отмену текущей временной скорости базала TBR, Combo на 15 минут установит TBR в 90% или 110%. Это делается из-за того, что отмена TBR вызывает лишние вибрации на помпе.
- Периодически (раз в несколько дней) AAPS может дать сбой оповещения TBR ОТМЕНЕН при автоматической отмене TBR. Пользователю придется самостоятельно разобраться с этим (нажав кнопку "обновить" в AAPS для передачи предупреждения в программу или подтвердив получение оповещения кнопкой помпы).
- Стабильность соединения по bluetooth различна в разных телефонах и может вызвать оповещение "помпа недоступна" когда соединение разорвано. 
- Если возникает эта ошибка, убедитесь, что Bluetooth включен, нажмите кнопку "обновить" на вкладке Комбо и проверьте, устранена ли проблема и если соединение не восстановится, перезагрузите телефон, что обычно исправляет ошибку. 
- Есть другая проблема, при которой перезапуск не помогает. В этом случае следует нажать на помпе кнопку, которая перезапускает bluetooth помпы и помпа снова начнет принимать соединение с телефоном. 
- В настоящее время мало что можно сделать для устранения этих проблем. Поэтому если подобные ошибки повторяются часто, подберите себе другой телефон, о котором известно, что он хорошо работает с AAPS и Комбо (см. выше).
- Подача болюса с помпы не всегда распознается вовремя (проверяется только во время соединения с AAPS) и в худшем случае может занять до 20 минут. 
- Болюсы помпы проверяются перед высоким временным базалом TBR или болюсом, подаваемым с AAPS, но из-за встроенных ограничений AAPS откажется подавать TBR/болюс, основанный на неверных расчетах. (-> Не подавайте болюс с помпы! См. главу [Использование](Accu-Chek-Combo-Pump-usage) ниже)
- Следует избегать программирования временного базала TBR на помпе, так как контроль над TBR задается алгоритмом AAPS. Обнаружение нового временного базала TBR на помпе может занять до 20 минут, а его действие принимается в расчет алгоритмом AAPS с момента обнаружения, так что в худшем случае TBR не будет учтен как активный инсулин IOB в течении 20 минут. 

## Настройки

- Настройте помпу с помощью конфигурирующей программы 360. 
- Если у вас нет этой программы, обратитесь в службу поддержки Акку-Чек. Обычно они высылают диск с программой "360° Pump Configuration Software" и устройство инфракрасной связи SmartPix зарегистрированным пользователям (устройство Realtyme также годится для этих целей).
- **Необходимые настройки** (отмечены зеленым в скриншотах):
    
    - Установите/оставьте конфигурацию меню как "Стандартная", в результате будут показаны только поддерживаемые меню/действия на помпе и уберутся неподдерживаемые (пролонгированный/многоволновый болюс, множественные скорости базала), которые ограничивают функционал помпы в безопасном режиме AAPS.
    - Убедитесь, что *Краткие сведения - текст* установлен на "КРАТКИЕ СВЕДЕНИЯ" (без кавычек, в разделе *Параметры инсулиновой помпы*).
    - Установите *Максимум корректировки* суммарной скорости базала TBR на 500%
    - Отключите *Сигнал окончания временного базала*
    - Установите *приращение длительности* временного базала на 15 мин
    - Включите Bluetooth

- **Рекомендуемые настройки** (отмечены синим цветом на снимках с экрана)
    
    - Установите сигнал оповещения о малом количестве инсулина в картридже на величину по своему усмотрению
    - Настройте максимальную величину болюса в соответствии с требованиями вашей терапии, но имея в виду защиту от ошибок в программном обеспечении
    - Аналогичным образом настройте максимальную продолжительность временного базала TBR на безопасный уровень. Установите эту величину по крайней мере на 3 часа, так как опция отключения помпы задает нулевой базал на 3 часа.
    - Включите блокировку клавиш помпы для предотвращения быстрой подачи болюса, особенно если быстрая подача болюса с помпы была в привычке до перехода на AAPS.
    - Задайте таймаут отключения экрана и меню минимум на 5,5 и 5 соответственно. Это позволяет AAPS быстрее восстановиться после ошибок и уменьшает количество вибраций во время таких ошибок

![Снимок экрана настроек меню пользователя](../images/combo/combo-menu-settings.png)

![Снимок экрана параметров TBR](../images/combo/combo-tbr-settings.png)

![Снимок экрана настроек болюса](../images/combo/combo-bolus-settings.png)

![Снимок экрана настроек для картриджей инсулина](../images/combo/combo-insulin-settings.png)

- Установите AAPS по инструкции в [AAPS wiki](https://androidaps.readthedocs.io/)
- Для правильной настройки AAPS внимательно прочитайте документацию.
- На этом этапе в настройках AAPS в разделе выбор помпы выберите подачу болюсов вручную (MDI), а не Комбо, чтобы избежать вмешательства в работу утилиты ruffy во время установки сопряжения.
- Clone ruffy via git from [MilosKozak/ruffy](https://github.com/MilosKozak/ruffy). At the moment, the primary branch is the `combo` branch, in case of problems you might also try the 'pairing' branch (see below).
- Build and install ruffy and use it to pair the pump. Если она не сработает после нескольких попыток, переключитесь на ветку `сопряжение`, установите связь с помпой и затем переключитесь обратно на исходную ветку. Если помпа уже сопряжена и может управляться через алгоритм, важно установить ветку `комбо`. Обратите внимание, что сопряжение - процесс плохо контролируемый (но выполняемый всего один раз) и, возможно, потребуется несколько попыток; своевременно реагируйте на запросы и, при необходимости повторить попытку, заранее удаляйте помпу из настроек Bluetooth. Можно попробовать другой вариант, который заключается в том, чтобы после начала процесса сопряжения войти в меню Bluetooth (это делает Bluetooth телефона видимым на время отображения в меню) и после подтверждения сопряжения, когда помпа показывает код авторизации, переключиться обратно на ruffy. Если вам не удалось настроить соединение с помпой (скажем, после 10 попыток) попробуйте ждать до 10 секунд, прежде чем подтвердить соединение на помпе (после появления наименования телефона на дисплее помпы). Если вы настроили тайм-аут меню меньше 5 сек., потребуется снова увеличить его. Некоторые пользователи сообщают, что им приходилось так делать. Наконец, попробуйте переместиться из одной комнаты в другую, чтобы избежать помех связи. Один из пользователей сообщил нам об устранении проблем соединения после простой перемены комнат.
- Когда AAPS пользуется алгоритмом ruffy, утилита ruffy недоступна. Самым простым выходом в этом случае является перезагрузить телефон после сопряжения и дать возможность алгоритму ruffy запуститься в фоновом режиме.
- Если помпа совершенно новая, требуется подать болюс на помпе, чтобы помпа произвела первую запись в логе.
- Прежде чем активировать расширение Combo в AAPS, убедитесь в правильной настройке профиля и в его активации (!) и что профиль базала актуален т. к. AAPS будет синхронизировать профиль с помпой. После этого активируйте расширение Combo. Нажмите кнопку *Обновить* на вкладке Combo для запуска помпы.
- Для проверки настроек, при отключенной помпе в режиме **отключено**, задайте в AAPS значение временного базала TBR 500% на 15 мин и подайте болюс. После этого в логах помпы появится работающий TBR и болюс. AAPS должен также показать активный TBR и поданный болюс.

(Accu-Chek-Combo-Pump-why-pairing-with-the-pump-does-not-work-with-the-app-ruffy)=

## Why pairing with the pump does not work with the app "ruffy"?

Существует несколько возможных причин. Попробуйте следующие действия:

1. Вставьте в помпу **свежие или полностью заряженные батареи**. Подробнее см. в разделе "батарея". Убедитесь, что помпа находится вблизи смартфона.

![Помпа Combo должна находиться рядом с телефоном](../images/Combo_next_to_Phone.png)

2. Отключите или удалите любые другие устройства bluetooth, чтобы они не смогли установить подключение к телефону во время сопряжения. Любая параллельная связь по bluetooth или запрос на соединение могут нарушить процесс сопряжения.

3. Delete already connected devices in the Bluetooth menu of the pump: **BLUETOOTH SETTINGS / CONNECTION / REMOVE** until **NO DEVICE** is shown.

4. Delete a pump already connected to the phone via Bluetooth: Under Settings / Bluetooth, remove the paired device "**SpiritCombo**"
5. Убедитесь, что AAPS не работает в фоновом режиме цикла. Деактивируйте цикл в AAPS.
6. Try using the '**pairing**' branch from the [MilosKozak/ruffy](https://github.com/MilosKozak/ruffy/tree/pairing) repository to establish the connection 
7. Запустите утилиту ruffy на телефоне. Можно нажать Reset! (Перезапустить) and remove the old connection. Then hit **Connect!**.
8. В меню Настройки Bluetooth помпы, перейдите к **СОПРЯЖ. УСТР. / ЗАПУСК СОПРЯЖ.**. Нажмите *CONNECT!** (НАЧАТЬ) 
    - The next three steps are timing-sensitive, so you might need to try different pauses/speed if pairing fails. Read the full sequence before trying it.

9. Теперь на помпе должно появиться название Bluetooth телефона, которое следует выбрать для сопряжения. Here it is importand to wait at least 5s before you hit the select button on Pump. В ином случае помпа не отправит правильный запрос на сопряжение с телефоном.
    
    - Если помпа Combo настроена на 5 сек ожидания с включенным экраном, ее можно протестировать за 40сек (исходный параметр). From experiance the time between pump is showing up in phone until select phone is around 5-10s. In many other cases pairing just times out without successfully pair. Later you should set it back to 5s, to meet AAPS Combo settings and speed up connections.
    - If the pump does not show the phone as a pairing device at all, your phone's Bluetooth stack is probably not compatible with the pump. Убедитесь, что вы используете новую **LineageOS ≥ 14.1** или **Android ≥ 8.1 (Oreo)**. If possible, try another smartphone. You can find a list of already successfully used smartphones under \[AAPS Phones\] (https://docs.google.com/spreadsheets/d/1gZAsN6f0gv6tkgy9EBsYl0BQNhna0RDqA9QGycAqCQc/edit#gid=698881435). 

10. Sometimes the phone asks for a (typically 4 digit) bluetooth PIN number that is not related to the 10 digit PIN later shown on the pump. Usually, ruffy will set this PIN automatically, but due to timing issues, this does not always work. If a request for a Bluetooth pairing PIN appears on the phone before any code is shown on the pump, you need to enter **}gZ='GD?gj2r|B}>** as the PIN. This is easiest done if you copy this 16 character text into the clipboard before starting the pairing sequence and just paste it in the dialog at this step. See related [Github issue](https://github.com/MilosKozak/ruffy/issues/14) for details.

11. At next the pump should show up a 10 digit security code. And Ruffy shold show a screen to enter it. So enter the code in Ruffy and you should be ready to go.
12. If pairing was not successful and you got a timeout on the pump, you will need to restart the process from scratch.
13. If you have used the 'Pairing' branch to build the ruffy app, now install the version build from the 'combo' branch on top of it. Make sure that you have used the same keys when signing the two versions of the app to be able to keep all setting and data, as they also contain the connection properties.
14. Перезагрузите телефон.
15. Теперь вы можете перезапустить цикл AAPS.

(Accu-Chek-Combo-Pump)=

## Применение

- Имейте в виду, что это не конечный продукт, особенно на начальном этапе пользователь должен научиться контролировать и понимать систему, ее ограничения и возможные сбои в работе. Настоятельно рекомендуем не пользоваться системой, если нет полного понимания принципов ее работы.
- Read the OpenAPS documentation https://openaps.org to understand the loop algorithm AAPS is based upon.
- Read the online documentation to learn about and understand AAPS https://androidaps.readthedocs.io/
- Данная интеграция обладает той же функциональностью что и пульт - глюкометр, поставляемый в комплекте с помпой. Глюкометр позволяет дублировать экран помпы и перенаправляет на помпу все команды (эквивалентные нажатию кнопок на помпе). Связь с помпой, равно как и это перенаправление команд является главным функционалом алгоритма приложения. A `scripter` component reads the screen and automates entering boluses, TBRs etc and making sure inputs are processed correctly. Алгоритм ИПЖ затем обменивается данными со скриптером, применяет команды цикла и подает болюсы. Этот режим имеет некоторые ограничения: он действует медленно (но достаточно быстро для своих задач), и изменение временного базала TBR или подача болюса приводит к вибрации помпы.
- The integration of the Combo with AAPS is designed with the assumption that all inputs are made via AAPS. Boluses entered on the pump directly will be detected by AAPS, but it can take up to 20 min before AAPS becomes aware of such a bolus. Reading boluses delivered directly on the pump is a safety feature and not meant to be regularly used (the loop requires knowledge of carbs consumed, which can't be entered on the pump, which is another reason why all inputs should be done in AAPS).
- Не устанавливайте и не отменяйте временный базал TBR на помпе. Алгоритм AAPS предполагает контроль над временным базалом, он не будет работать надежно при иных решениях, поскольку начало подачи временного базала, заданного пользователем на помпе, невозможно определить.
- Первый базальный профиль помпы считывается при запуске приложения и обновляется алгоритмом AAPS. Скорость подачи базала не должна меняться вручную на помпе, но будет обнаружена и скорректирована как мера безопасности (не полагайтесь на меры безопасности, задаваемые по умолчанию, они предназначены для обнаружения непреднамеренных изменений на помпе).
- Рекомендуется включить кодовую блокировку на помпе для предотвращения случайной подачи болюса с помпы, особенно если вы уже пользовались помпой раньше и подача "быстрого болюса" вошла в привычку. Помимо этого, при активной блокировке, случайное нажатие на кнопку помпы НЕ прерывает коммуникацию между AAPS и помпой.
- Когда на помпе срабатывает оповещение ОТМЕНА БОЛЮСА / врем. базала TBR во время подачи болюса или установки врем. базала TBR, что иногда бывает, то это вызывается потерей соединения между помпой и телефоном. AAPS будет пытаться восстановить соединение, подтвердить сигнал и повторно выполнить последнее действие (болюсы не повторяются из соображений безопасности). Таким образом, это оповещение можно проигнорировать т. к. AAPS подтверждает его автоматически, обычно в течение 30 секунд (отменить его не составляет труда, но приведет к тому, что исполняемое в данный момент действие будет приостановлено до того, как экран помпы погаснет и ваше устройство вновь не подключится к помпе). Если оповещение помпы продолжает работать и автоматическое подтверждение не состоялось, пользователь должен подтвердить получение сигнала вручную.
- Когда оповещение о заканчивающемся инсулине или низком заряде батареи срабатывает во время болюса, они подтверждаются автоматически и появляются в AAPS в виде уведомления. Если они срабатывают в момент отсутствия связи с помпой, нажатие кнопки "обновить" (refresh) на вкладке Combo подтвердит получение сигнала и подаст уведомление в AAPS.
- Когда подтверждение получения сигнала об отмене скорости временного базала (TBR CANCELLED) не срабатывает в AAPS или когда срабатывает другое оповещение, нажатие кнопки "обновить" (refresh) на вкладке Combo восстановит соединение, подтвердит получение сигнала и подаст уведомление в AAPS. Такие манипуляции безопасны ввиду безопасности самих оповещений - соответствующая скорость временного базала будет снова задана во время следующего цикла работы алгоритма.
- Для всех других оповещений, инициируемых помпой: подключение к помпе покажет оповещение во вкладке Combo, например «состояние: Е4: закупорка», которое дублируется на главном экране. Любая ошибка системы генерирует срочное уведомление. AAPS никогда самостоятельно не подтверждает получения оповещений о серьезных ошибках и дает возможность помпе сигналить и вибрировать, чтобы пользователь имел возможность самостоятельно удостовериться в наличии критической ситуации, требующей его действий.
- После установки соединения с помпой, не следует запускать утилиту ruffy (AAPS, как ему и следует, запустится в фоновом режиме); независимая работа утилиты ruffy не предусмотрена.
- Если AAPS прекращает работу (в результате серьезной ошибки или останавливается из отладчика) когда телефон с AAPS и помпа обмениваются данными (при помощи ruffy), возможно потребуется принудительная остановка ruffy. Перезапуск приложения AAPS перезапустит и ruffy. Перезапуск телефона - простой способ устранить проблему, если вы не знаете, как принудительно убить все процессы приложения.
- Не нажимайте никаких кнопок на помпе во время обмена данными между AAPS и помпой (на экране помпы в это время высвечивается логотип блутуса).